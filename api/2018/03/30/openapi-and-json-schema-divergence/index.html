<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>OpenAPI and JSON Schema Divergence: Part 1 | Phil Sturgeon</title>
  <meta name="description" content="Platform Engineer @ WeWork who talks about APIs a lot. Programming Polyglot, Pragmatist, Centerist and Sarcasist. Ex-The League of Extraordinary Packages, PHP The Right Way, Ex-PHP-FIG, Ex-CodeIgniter, Ex-FuelPHP, Ex-PyroCMS." />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link href="/stylesheets/main.css" rel="stylesheet" media="screen" />
  <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
  <link href="/images/favicon.jpg" rel="icon" type="image/jpg" />

  <meta property="og:title" content="OpenAPI and JSON Schema Divergence: Part 1" />
  <meta property="og:type" content="article" />
  <meta property="article:author" content="Phil Sturgeon" />
  <meta property="og:description" content="This article is going to explain the divergence between OpenAPI and JSON Schema, which I&#x27;ve been calling the subset&#x2F;superset&#x2F;sideset problem. It&#x27;ll finish up explaining how we&#x27;re going to solve it, and ~I&#x27;ll write part 2 when it is solved~ part two explains the solution." />
  <meta property="og:site_name" content="Phil Sturgeon" />
  <meta property="og:image" content="https://philsturgeon.uk/images/author.jpg" />
  <meta property="og:url" content="https://philsturgeon.uk/api/2018/03/30/openapi-and-json-schema-divergence/" />
  <meta property="og:locale" content="en_GB" />

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@philsturgeon">
  <meta name="twitter:title" content="OpenAPI and JSON Schema Divergence: Part 1 | Phil Sturgeon">
  <meta name="twitter:image:src" content="https://philsturgeon.uk/images/author.jpg">
  <meta name="twitter:url" content="https://philsturgeon.uk/api/2018/03/30/openapi-and-json-schema-divergence/">
  <meta name="twitter:description" content="This article is going to explain the divergence between OpenAPI and JSON Schema, which I&#x27;ve been calling the subset&#x2F;superset&#x2F;sideset problem. It&#x27;ll finish up explaining how we&#x27;re going to solve it, and ~I&#x27;ll write part 2 when it is solved~ part two explains the solution.">
  <meta name="twitter:creator" content="@philsturgeon">

  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
</head>


  <body>

    <a class='fa fa-home logo-readium' href='/'></a>


    <!-- content start -->

    <main class="content" role="main">
      <article class="post">
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">OpenAPI and JSON Schema Divergence: Part 1</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/images/author.jpg)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person">Phil Sturgeon</h4>
              on
              <time datetime="2018-03-30 16:44:00 UTC">
                Mar 30 2018
              </time>
              <a href="/tag/api/">#api</a>
              <a href="/tag/json-schema/">#json-schema</a>
              <a href="/tag/api-specs/">#api-specs</a>
              <a href="/tag/openapi/">#openapi</a>
            </div>
          </div>
        </div>
        <br>
        <br>
        <br>
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <hr>

          <p>This article is going to explain the divergence between OpenAPI and JSON Schema, which I've been calling the subset/superset/sideset problem. It'll finish up explaining how we're going to solve it, and ~I'll write part 2 when it is solved~ <a href="/api/2018/04/13/openapi-and-json-schema-divergence-solved/">part two explains the solution</a>.</p>

<hr />

<p>Whenever talking about API specifications it is impossible to avoid mentioning OpenAPI and JSON Schema. They're the two main solutions for any sort of API that doesn't have a type system forcibly jammed into it by default.</p>

<p>Often you'll need OpenAPI for one thing, and JSON Schema for another. OpenAPI has <a href="https://blog.apisyouwonthate.com/turning-contracts-into-beautiful-documentation-deac7013af18">amazing API documentation tools</a>, fancy SDK generators, and handles loads of API-specific functionality that JSON Schema doesn't even go near. It also has a focus on keeping this static, for strictly typed languages, where properties should be 1 type and 1 type only.</p>

<p>JSON Schema focuses on very flexible data modeling with the same sort of validation vocabulary as OpenAPI, but for more flexible data sets. Whilst it doesn't focus just on APIs, by using more advanced vocabularies like <a href="https://blog.apisyouwonthate.com/getting-started-with-json-hyper-schema-184775b91f">JSON Hyper-Schema</a> it can model a fully RESTful API and its hypermedia controls (HATEOAS). JSON Schema can <a href="https://blog.apisyouwonthate.com/the-many-amazing-uses-of-json-schema-client-side-validation-c78a11fbde45">offer server-defined client-side validation</a>, and a bunch of other fantastic stuff that OpenAPI doesn't really aim to do.</p>

<p>Over the last year I've been <a href="https://philsturgeon.uk/api/2017/07/20/my-vision-for-a-perfect-world-in-api-specification/">chasing the perfect workflow</a>, and one of my main requirements when evaluating the common API specs was JSON Schema support. The situation overall was pretty bleak, not just in supporting JSON Schema, but a lot of tooling was just… not great.</p>

<p>Eight months after that article things are <em>better</em>, and the design-first API specification workflow I've been dreaming of <a href="https://philsturgeon.uk/api/2018/03/01/api-specification-workflow-matures/">has been maturing</a> around me. to a point where I'm really happy about most stuff!</p>

<p>OpenAPI is often described as an extension of JSON Schema, but both specs have changed over time and grown independently. OpenAPI v2 was based on JSON Schema draft v4 with a long list of deviations, but OpenAPI v3 shrank that list, upping their support to draft v5 and making the list of discrepancies shorter. Despite OpenAPI v3 closing the gap, the issue of JSON Schema divergence has not been resolved fully, and with newer drafts of JSON Schema coming out, the divergence is actually getting worse over time. Currently OpenAPI is still on draft 5, and JSON Schema has released draft 8.</p>

<p><img alt="A list of caveats to the JSON Schema support in OpenAPI v3.0" src="/images/article_images/2018-03-30-openapi-and-json-schema-divergence/json-schema-oai-differences.png" /></p>

<p>I've been punting this issue for a while in my articles and recommendations at work. The hope was that by the time folks at work had upgraded to v3, there might be a v3.1 out solving the situation, but that has not come to pass. Now I find myself suggesting folks find some way to convert one to the other, or try to write JSON Schema that <em>is</em> compatible with OpenAPI.</p>

<p><img alt="Carefully writing JSON Schema for your data model kiiiinda works" src="/images/article_images/2018-03-30-openapi-and-json-schema-divergence/data-model-service-model.png" /></p>

<p>The latter can be done, but eventually you'll get bit by something. At work we've been writing JSON Schema files, using them for contract testing and a bunch of other stuff, then rendering them as part of our OpenAPI Docs with ReDoc. ReDoc will let you use <code>type: [string, null]</code>, but now we've got <a href="https://github.com/wework/speccy">Speccy</a> linting our packages, it's reporting that as invalid OpenAPI…</p>

<pre class="highlight shell"><code><span class="gp">$ </span>speccy lint docs/openapi.yml
Specification schema is invalid.

<span class="c">#/paths/~1foo/post/requestBody/content/application~1json/properties/user_uuid</span>
expected Array <span class="o">[</span> <span class="s1">'string'</span>, <span class="s1">'null'</span> <span class="o">]</span> to be a string
    expected Array <span class="o">[</span> <span class="s1">'string'</span>, <span class="s1">'null'</span> <span class="o">]</span> to have <span class="nb">type </span>string
        expected <span class="s1">'object'</span> to be <span class="s1">'string'</span>
</code></pre>

<p>If I change that to valid OpenAPI and use <code>type: string</code> with <code>nullable: true</code> instead, validators like Speccy will be happy, but my JSON Schema contract tests will break as they no longer know that <code>null</code> is an acceptable value for that field.</p>

<p>This error was the final straw for me. At work I have been recommending everyone enable Speccy on CircleCI to (amongst other things) make sure we're writing valid OpenAPI, and I am failing to write valid OpenAPI in an API I manage. I'm also a little tired of explaining this awkward difference to people who would like to use some JSON Schema-based tools.</p>

<p>After grumping at Darrel Miller (a contributor to OpenAPI) and others on the <a href="https://slack.apisyouwonthate.com/">APIs You Won't Hate slack</a>, some good ideas started to pop up. Darrel is going to try and draft up an extension to OpenAPI that could theoretically end up in a future version - like 3.1 or 4.0:</p>

<pre class="highlight yaml"><code><span class="s">x-oas-draft-alternate-schema</span><span class="pi">:</span>
 <span class="s">schemaType</span><span class="pi">:</span> <span class="s">json-schema-07</span>
 <span class="s">schemaRef</span><span class="pi">:</span>  <span class="s">./myrealschema.json</span>
</code></pre>

<p>This would allow support for various JSON Schema drafts, and any other data model you can think of; including protobuf. The decisions of which data model formats to support would be in the hands of tool vendors. Of course this would increase work for these vendors, and decrease portability for a while as you can only use tools that support your alternate schea, but ultimately solve a <em>lot</em> of problems.</p>

<p>There's some stuff to flesh out, and obvious limitations around which schemas can $ref which other schemas, but there is definitely a solution here. It'll take some time to get it done, and in that time we all need a solution.</p>

<p>One approach would be trying to use OpenAPI for all the things, write validators and RSpec tools that do this, but we'd have to be 100% OpenAPI for everything, and we'd never get to play with client validation, Hyper-Schema, etc.</p>

<p>Another approach would be converting our OpenAPI models to JSON Schema, but that seems a bit lossy. OpenAPI v3 is based on JSON Schema draft v5, and at time of writing JSON Schema is up to draft v8… This also adds a build step that gets in the way. If you are using JSON Schema for your contract testing, with something like <a href="https://github.com/thoughtbot/json_matchers">thoughtbot/json_matchers</a>, you would need to edit your OpenAPI model, run the conversion, then run the tests. Or crowbar a conversion into your test suite, meaning the tool handling the conversion needs to be written in that specific language… or pipe a shell command to the CLI… AGH RUN AWAY.</p>

<p>No, I think making JSON Schema (latest possible draft) the one and only source of truth for the data model, then "downgrading" to a flavour of JSON Schema that OpenAPI likes, is going to be the way to go.</p>

<p>To do this, a suite of JavaScript tools are going to be created.</p>

<h3 id="json-schema-to-openapi">json-schema-to-openapi</h3>

<p>Basically I'm going to flip <a href="https://github.com/mikunn/openapi-schema-to-json-schema">openapi-to-json-schema</a> around.</p>

<p>A simple CLI package that will take a JSON Schema draft 4 file, and make it perfectly OpenAPI friendly, stripping out any keywords that would cause harm.</p>

<h3 id="json-schema-migrator">json-schema-migrator</h3>

<p>Henry Andrews (author of JSON Schema) is going to release this package, to convert files from any draft version to any other by stepping up and down. This will be really handy for all sorts of things, the most obvious use being upgrading schema files when new drafts come out.</p>

<p>This package will be used by json-schema-to-openapi to accept input in any JSON Schema draft version, and migrate it to v5 before converting to OpenAPI.</p>

<h3 id="speccy-to-the-rescue">Speccy to the rescue</h3>

<p>Right now Speccy has a few commans: lint, serve, resolve.</p>

<p>Lint checks the files are valid, serve creates a HTTP server and renders your docs with ReDoc, and resolve pulls in all the $ref's to create one mega-file. All of these commands could support a <code>-j / --json-schema</code> switch, which would send all <code>.json</code> files off to json-schema-to-openapi.</p>

<p>Conversion this way should avoid the need for a build step. Changing the JSON Schema data model files mean anything you're using JSON Schema for (contract testing for example) are already happy.</p>

<p>Stuff you're doing locally with OpenAPI is usually checking the docs after editing the files, or linting things to see if your changes are ok. Both of these workflows will continue to work once Speccy is passing things through the convertor at run time, and if you <em>do</em> need pure OpenAPI you can use resolve to create a plain OpenAPI file. 😁</p>

<p>So, with the problem well and truly understood and explained, let's get to work on fixing it! Darrel, Henry, and myself, will all be hard at work: just for you!</p>

<p>Get in touch on <a href="https://slack.apisyouwonthate.com/">APIs You Won't Hate Slack</a> if you're interested. We have #openapi, #json-schema and a bunch of other channels.</p>

<p><strong>Part Two:</strong> <a href="/api/2018/04/13/openapi-and-json-schema-divergence-solved/">Problem Solved!</a></p>


          <hr>
<p>
  <em>If you appreciate these articles and want me to keep them coming, fire some coins over. Maybe I'll even run the next one through a spell checker.</em>
</p>
<p>
  <em>
    <strong>bitcoin</strong> - 1PNbuCjgATjaaHtq7zZKqe3FBL7ngyDi23<br/>
    <strong>etherium</strong> - 0x507d6E943885a5AeD76Fa3C43dB5C73a0f1Dc792
  </em>
</p>

        </section>
        <footer class="post-footer">
            <section class="share">
            </section>
            <section class="post-next-previous">
                <p>
                    Previous:
                    <a class="button" href="/api/2018/03/01/api-specification-workflow-matures/">Design-first API Specification Workflow Matures</a>
                </p>
                <p style="float:right">
                    Next:
                    <a class="button" href="/api/2018/04/13/openapi-and-json-schema-divergence-solved/">OpenAPI and JSON Schema Divergence: Part 2</a>
                </p>
            </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="more isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/images/author.jpg)">Blog Logo</div>
              <h4>Phil Sturgeon</h4>
              <p class="bio">Platform Engineer @ WeWork who talks about APIs a lot. Programming Polyglot, Pragmatist, Centerist and Sarcasist. Ex-The League of Extraordinary Packages, PHP The Right Way, Ex-PHP-FIG, Ex-CodeIgniter, Ex-FuelPHP, Ex-PyroCMS.</p>
            </section>
          </div>
          <div class="more isRight">
            <h5 class="index-headline featured"><span>More Writing</span></h5>
            <section class="author">
              <a href="http://apisyouwonthate.com/">
                <div class="book-image build-apis">Book Cover</div>
                <h4>Build APIs You Won't Hate</h4>
              </a>
              <p class="bio">Everyone and their dog wants an API, so you should probably learn how to build them.</p>
              <p><a href="http://apisyouwonthate.com/">Buy it from LeanPub or Amazon</a>.</p>
            </section>
          </div>
        </div>
      </article>

      <div id="disqus_thread"></div>
      <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'philsturgeon';


          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </main>
    <div class="bottom-closer">
      <div class="background-closer-image" style="background-image: url(/images/cover.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">Phil Sturgeon</h1>
        <h2 class="blog-description">Platform Engineer @ WeWork who talks about APIs a lot. Programming Polyglot, Pragmatist, Centerist and Sarcasist. Ex-The League of Extraordinary Packages, PHP The Right Way, Ex-PHP-FIG, Ex-CodeIgniter, Ex-FuelPHP, Ex-PyroCMS.</h2>
        <a href="/" class="btn">Back to Overview</a>
      </div>
    </div>

    <!-- content end -->

    <footer class='footer' role='contentinfo'>
  <div class='footer-links'>
    <ul class='context'>
      <li>
        <h3>Content</h3>
      </li>
      <li>
        <a href='/about'>About</a>
      </li>
      <li>
        <a href='/books'>Books</a>
      </li>
      <li>
        <a href='/speaking'>Speaking</a>
      </li>
    </ul>
    <ul class='follow'>
      <li>
        <h3>Follow Me</h3>
      </li>
      <li>
        <a href='https://twitter.com/philsturgeon'>Twitter</a>
      </li>
      <li>
        <a href='https://github.com/philsturgeon'>GitHub</a>
      </li>
      <li>
        <a href='http://apibusters.com/'>API Busters Podcast</a>
      </li>
      <li>
        <a href='http://phil.bike/'>Phil.Bike</a>
      </li>
    </ul>
    <ul class='recent_posts'>
      <li>
        <h3>Recent Posts</h3>
        <ul>
          <li><a href="/api/2018/04/13/openapi-and-json-schema-divergence-solved/">OpenAPI and JSON Schema Divergence: Part 2</a></li>
          <li><a href="/api/2018/03/30/openapi-and-json-schema-divergence/">OpenAPI and JSON Schema Divergence: Part 1</a></li>
          <li><a href="/api/2018/03/01/api-specification-workflow-matures/">Design-first API Specification Workflow Matures</a></li>
        </ul>
      </li>
    </ul>
  </div>
</footer>

    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="/javascripts/jquery.fitvids.js"></script>
<script src="/javascripts/index.js"></script>
<script src="/javascripts/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    $window.on('scroll', function() {
      var top = $window.scrollTop();

      if (top < 0 || top > 1500) { return; }
      $image
        .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
        .css('opacity', 1-Math.max(top/700, 0));
    });
    $window.trigger('scroll');

    var height = $('.article-image').height();
    $('.post-content').css('padding-top', height + 'px');

    $('a[href*=#]:not([href=#])').click(function() {
      if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
       && location.hostname == this.hostname) {
        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
        if (target.length) {
          $('html,body').animate({ scrollTop: target.offset().top }, 500);
          return false;
        }
      }
    });
  });
}(jQuery));
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8523256-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>

</html>
