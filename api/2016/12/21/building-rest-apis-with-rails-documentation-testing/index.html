<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Building APIs with Rails: Documentation Testing | Phil Sturgeon</title>
  <meta name="description" content="Platform Engineer @ WeWork who talks about APIs a lot. Programming Polyglot, Pragmatist, Centerist and Sarcasist. Ex-The League of Extraordinary Packages, PHP The Right Way, Ex-PHP-FIG, Ex-CodeIgniter, Ex-FuelPHP, Ex-PyroCMS." />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link href="/stylesheets/main.css" rel="stylesheet" media="screen" />
  <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
  <link href="/images/favicon.jpg" rel="icon" type="image/jpg" />

  <meta property="og:title" content="Building APIs with Rails: Documentation Testing" />
  <meta property="og:type" content="article" />
  <meta property="article:author" content="Phil Sturgeon" />
  <meta property="og:description" content="Now that we&#x27;ve started building a very basic API, we should make sure that the documentation is kept up to date with our progress. Even better, we can use our documentation as a basic contract test, to make sure we aren&#x27;t lying about what our API offers." />
  <meta property="og:site_name" content="Phil Sturgeon" />
  <meta property="og:image" content="https://philsturgeon.uk/images/author.jpg" />
  <meta property="og:url" content="https://philsturgeon.uk/api/2016/12/21/building-rest-apis-with-rails-documentation-testing/" />
  <meta property="og:locale" content="en_GB" />

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@philsturgeon">
  <meta name="twitter:title" content="Building APIs with Rails: Documentation Testing | Phil Sturgeon">
  <meta name="twitter:image:src" content="https://philsturgeon.uk/images/author.jpg">
  <meta name="twitter:url" content="https://philsturgeon.uk/api/2016/12/21/building-rest-apis-with-rails-documentation-testing/">
  <meta name="twitter:description" content="Now that we&#x27;ve started building a very basic API, we should make sure that the documentation is kept up to date with our progress. Even better, we can use our documentation as a basic contract test, to make sure we aren&#x27;t lying about what our API offers.">
  <meta name="twitter:creator" content="@philsturgeon">

  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
</head>


  <body>

    <a class='fa fa-home logo-readium' href='/'></a>


    <!-- content start -->

    <main class="content" role="main">
      <article class="post">
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">Building APIs with Rails: Documentation Testing</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/images/author.jpg)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person">Phil Sturgeon</h4>
              on
              <time datetime="2016-12-21 11:59:23 UTC">
                Dec 21 2016
              </time>
              <a href="/tag/building-rest-apis-in-rails/">#building-rest-apis-in-rails</a>
              <a href="/tag/http/">#http</a>
              <a href="/tag/api/">#api</a>
              <a href="/tag/video/">#video</a>
              <a href="/tag/dredd/">#dredd</a>
            </div>
          </div>
        </div>
        <br>
        <br>
        <br>
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>More videos in this practice series "Building REST APIs with Rails":</p>
<ul>
  <li>
    Episode 1:
    <a href='/api/2016/11/22/apis-documentation-first/'>Documenting Your API First</a>
  </li>
  <li>
    Episode 2:
    <a href='/api/2016/12/02/mocking-apis-with-api-blueprint/'>Mocking APIs with API Blueprint</a>
  </li>
  <li>
    Episode 3:
    <a href='/api/2016/12/11/building-apis-with-rails-basic-serialization/'>Basic Serialization</a>
  </li>
  <li>
    Episode 4:
    <a href='/api/2016/12/21/building-rest-apis-with-rails-documentation-testing/'>Documentation Testing</a>
  </li>
  <li>
    Episode 5 & 6:
    <a href='/api/2017/01/03/building-apis-with-rails-handling-errors-nicely/'>Handling Errors Nicely</a>
  </li>
</ul>
<hr>

          <p>Now that we've started building a very basic API, we should make sure that the documentation is kept up to date with our progress. Even better, we can use our documentation as a basic contract test, to make sure we aren't lying about what our API offers.</p>

<p>I've written tutorials in the past about <a href="https://philsturgeon.uk/api/2015/01/28/dredd-api-testing-documentation/">how Dredd works</a>, so this video will just go over this stuff in a bit more detail.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/dJXTWVuE89Q" frameborder="0" allowfullscreen=""></iframe>

<p><strong><a href="https://github.com/philsturgeon/livecoding-apisyouwonthate/tree/master/episode-04-contract-testing-with-dredd">Source Code</a></strong></p>

<hr />

<h2 id="notes">Notes</h2>

<p>You can easily install dredd using npm:</p>

<pre class="highlight shell"><code>npm install -g dredd
</code></pre>

<p>Once installed, you can use its init function to set things up:</p>

<pre class="highlight plaintext"><code>dredd init
</code></pre>

<p>With the correct values added, running dredd is a single command. The output can be a little verbose, so I like to pipe it to a log file:</p>

<pre class="highlight plaintext"><code>dredd &gt; log/dredd.log
</code></pre>

<p>For dredd to work, there needs to be data in the database. If you make a request to <code>/products/1</code> and there is no record with ID=1 in the database, then it will return a <code>404</code> response, instead of a <code>200</code> response with all the expected attributes.</p>

<p>To solve this we can use database seeding. A lot of apps use seeding for other things, so it can be really useful to make a custom seed out of the way of anything else:</p>

<pre class="highlight ruby"><code><span class="c1"># lib/tasks/custom_seeds.rake</span>
<span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:seed</span> <span class="k">do</span>
    <span class="no">Dir</span><span class="p">[</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">,</span> <span class="s1">'db'</span><span class="p">,</span> <span class="s1">'seeds'</span><span class="p">,</span> <span class="s1">'*.rb'</span><span class="p">)].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">filename</span><span class="o">|</span>
      <span class="n">task_name</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'.rb'</span><span class="p">).</span><span class="nf">intern</span>
      <span class="n">task</span> <span class="n">task_name</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
        <span class="nb">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Now, we can populate the seeds with really basic record creation. In fact, this is the same stuff we used in episode 3:</p>

<pre class="highlight ruby"><code><span class="c1"># db/seeds/dredd.rb</span>

<span class="n">manufacturer</span> <span class="o">=</span> <span class="no">Manufacturer</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Thatchers"</span><span class="p">,</span> <span class="ss">about: </span><span class="s2">"Pretty solid cider makers who are randomly moving their factories in the south west and going to Ireland..."</span><span class="p">,</span> <span class="ss">city: </span><span class="s2">"Dublin"</span><span class="p">,</span> <span class="ss">country: </span><span class="s2">"Ireland"</span><span class="p">)</span>

<span class="no">Product</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">manufacturer: </span><span class="n">manufacturer</span><span class="p">,</span> <span class="ss">name: </span><span class="s1">'Katies'</span><span class="p">,</span> <span class="ss">description: </span><span class="s2">"Unnecessarily strong fizzy cider that sells for the same price as normal ciders."</span><span class="p">,</span> <span class="ss">apv: </span><span class="mi">7</span><span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="ss">product_type: </span><span class="s1">'cider'</span><span class="p">)</span>

<span class="no">Product</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">manufacturer: </span><span class="n">manufacturer</span><span class="p">,</span> <span class="ss">name: </span><span class="s1">'Thatchers Dry'</span><span class="p">,</span> <span class="ss">description: </span><span class="s2">"As the name suggests this is dry, and a little tangy."</span><span class="p">,</span> <span class="ss">apv: </span><span class="mi">6</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="ss">product_type: </span><span class="s1">'cider'</span><span class="p">)</span>
</code></pre>

<p>To check that works, you can run it with the following command:</p>

<pre class="highlight shell"><code>rake db:seed:dredd
</code></pre>

<p>In isolation, that is not very helpful. We also don't want to mess with our development database. Using the entire following command, you can use the testing database, create a fresh DB every time, load the schema up, then run dredd.</p>

<pre class="highlight shell"><code><span class="nv">RAILS_ENV</span><span class="o">=</span><span class="nb">test </span>rake db:drop db:create db:migrate db:seed:dredd <span class="o">&amp;&amp;</span> dredd
</code></pre>

<p>This would be a fairly annoying command to have to remember, wrap it up in a simple <code>Makefile</code>:</p>

<pre class="highlight shell"><code><span class="c"># Makefile</span>
.PHONY: docs_test
docs_test:
		@echo <span class="s2">"Seeding database for documentation testing"</span>
		@RAILS_ENV<span class="o">=</span><span class="nb">test </span>rake db:drop db:create db:migrate db:seed:dredd
		@echo <span class="s2">"Running dredd... check logs/dredd.log for more information"</span>
		@RAILS_ENV<span class="o">=</span><span class="nb">test </span>dredd &gt; log/dredd.log <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"Documentation is all good!"</span>
</code></pre>

<p>With that <code>Makefile</code> in your project root, you can simply run this:</p>

<pre class="highlight shell"><code><span class="gp">$ </span>make docs_test
</code></pre>

<p>We'll be making a few more make commands over the next few videos. They're really useful!</p>

<h2 id="interested-in-a-proper-series">Interested in a Proper Series?</h2>

<p>These rough videos will be replaced with a nicely recorded series, and to get updates about that, just let me know your email address.</p>

<!-- Begin MailChimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css" />

<style type="text/css">
	#mc_embed_signup{background:#fff; clear:left; font:14px; width:100%;}
	/* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
	   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>

<div id="mc_embed_signup">
<form action="//apisyouwonthate.us10.list-manage.com/subscribe/post?u=f5c5ff66d95d11dec1b88cf54&amp;id=bef95bfd48" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
    <div id="mc_embed_signup_scroll">

	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required="" />
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_f5c5ff66d95d11dec1b88cf54_bef95bfd48" tabindex="-1" value="" /></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button" /></div>
    </div>
</form>
</div>

<!--End mc_embed_signup-->

          <hr>
<p>
  <em>If you appreciate these articles and want me to keep them coming, fire some coins over. Maybe I'll even run the next one through a spell checker.</em>
</p>
<p>
  <em>
    <strong>bitcoin</strong> - 1PNbuCjgATjaaHtq7zZKqe3FBL7ngyDi23<br/>
    <strong>etherium</strong> - 0x507d6E943885a5AeD76Fa3C43dB5C73a0f1Dc792
  </em>
</p>

        </section>
        <footer class="post-footer">
            <section class="share">
            </section>
            <section class="post-next-previous">
                <p>
                    Previous:
                    <a class="button" href="/api/2016/12/11/building-rest-apis-with-rails-basic-serialization/">Building REST APIs with Rails: Basic Serialization</a>
                </p>
                <p style="float:right">
                    Next:
                    <a class="button" href="/api/2017/01/03/building-apis-with-rails-handling-errors-nicely/">Building APIs with Rails: Handling Errors Nicely</a>
                </p>
            </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="more isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/images/author.jpg)">Blog Logo</div>
              <h4>Phil Sturgeon</h4>
              <p class="bio">Platform Engineer @ WeWork who talks about APIs a lot. Programming Polyglot, Pragmatist, Centerist and Sarcasist. Ex-The League of Extraordinary Packages, PHP The Right Way, Ex-PHP-FIG, Ex-CodeIgniter, Ex-FuelPHP, Ex-PyroCMS.</p>
            </section>
          </div>
          <div class="more isRight">
            <h5 class="index-headline featured"><span>More Writing</span></h5>
            <section class="author">
              <a href="http://apisyouwonthate.com/">
                <div class="book-image build-apis">Book Cover</div>
                <h4>Build APIs You Won't Hate</h4>
              </a>
              <p class="bio">Everyone and their dog wants an API, so you should probably learn how to build them.</p>
              <p><a href="http://apisyouwonthate.com/">Buy it from LeanPub or Amazon</a>.</p>
            </section>
          </div>
        </div>
      </article>

      <div id="disqus_thread"></div>
      <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'philsturgeon';


          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </main>
    <div class="bottom-closer">
      <div class="background-closer-image" style="background-image: url(/images/cover.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">Phil Sturgeon</h1>
        <h2 class="blog-description">Platform Engineer @ WeWork who talks about APIs a lot. Programming Polyglot, Pragmatist, Centerist and Sarcasist. Ex-The League of Extraordinary Packages, PHP The Right Way, Ex-PHP-FIG, Ex-CodeIgniter, Ex-FuelPHP, Ex-PyroCMS.</h2>
        <a href="/" class="btn">Back to Overview</a>
      </div>
    </div>

    <!-- content end -->

    <footer class='footer' role='contentinfo'>
  <div class='footer-links'>
    <ul class='context'>
      <li>
        <h3>Content</h3>
      </li>
      <li>
        <a href='/about'>About</a>
      </li>
      <li>
        <a href='/books'>Books</a>
      </li>
      <li>
        <a href='/speaking'>Speaking</a>
      </li>
    </ul>
    <ul class='follow'>
      <li>
        <h3>Follow Me</h3>
      </li>
      <li>
        <a href='https://twitter.com/philsturgeon'>Twitter</a>
      </li>
      <li>
        <a href='https://github.com/philsturgeon'>GitHub</a>
      </li>
      <li>
        <a href='http://apibusters.com/'>API Busters Podcast</a>
      </li>
      <li>
        <a href='http://phil.bike/'>Phil.Bike</a>
      </li>
    </ul>
    <ul class='recent_posts'>
      <li>
        <h3>Recent Posts</h3>
        <ul>
          <li><a href="/api/2018/04/13/openapi-and-json-schema-divergence-solved/">OpenAPI and JSON Schema Divergence: Part 2</a></li>
          <li><a href="/api/2018/03/30/openapi-and-json-schema-divergence/">OpenAPI and JSON Schema Divergence: Part 1</a></li>
          <li><a href="/api/2018/03/01/api-specification-workflow-matures/">Design-first API Specification Workflow Matures</a></li>
        </ul>
      </li>
    </ul>
  </div>
</footer>

    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="/javascripts/jquery.fitvids.js"></script>
<script src="/javascripts/index.js"></script>
<script src="/javascripts/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    $window.on('scroll', function() {
      var top = $window.scrollTop();

      if (top < 0 || top > 1500) { return; }
      $image
        .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
        .css('opacity', 1-Math.max(top/700, 0));
    });
    $window.trigger('scroll');

    var height = $('.article-image').height();
    $('.post-content').css('padding-top', height + 'px');

    $('a[href*=#]:not([href=#])').click(function() {
      if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
       && location.hostname == this.hostname) {
        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
        if (target.length) {
          $('html,body').animate({ scrollTop: target.offset().top }, 500);
          return false;
        }
      }
    });
  });
}(jQuery));
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8523256-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>

</html>
